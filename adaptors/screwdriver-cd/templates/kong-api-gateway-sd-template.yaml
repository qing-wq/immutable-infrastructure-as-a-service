# Copyright Jiaqi Liu
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
---
namespace: paion-data
name: kong-api-gateway-release-definition-template
version: "1.0.0"
description: |
  Screwdriver CD template for deploying Kong API Gateway (https://github.com/paion-data/docker-kong) to AliCloud through HashiCorp.
maintainer: jack20220723@gmail.com
config:
  image: buildpack-deps:22.04-scm
  parameters:
    region:
      value: "cn-shenzhen"
      description: "The AWS region where Kong API Gateway AMI will be published to. The published image will be private"
    ali-image-name:
      value: "ecs-kong"
      description: "The published AMI name; it can be arbitrary"
    instance-type:
      value: "ecs.e-c1m1.large"
      description: "The EC2 instance type to use when building an AMI as well as launching the instance"
    instance-name:
      value: "kong-gateway-instance"
      description: "The deployed EC2 name as appeared in the instance list of AWS console; it can be arbitrary"
    security-groups:
      value: '["sg-wz907b4kxw86kejdynhl"]'
      description: "The list of AWS Security Group names (yes, not ID, but name...) bound to the Kong EC2 instance."
    vswitch_id:
      value: "vsw-wz9qs7bztf98sstrb1ymm"
      description: "The VSwitch ID to use when launching the instance"
    ssl_cert_source:
      value: "server.crt"
      description: "The source of the SSL certificate file"
    ssl_cert_key_source:
      value: "server.key"
      description: "The source of the SSL certificate key file"
    kong-api-gateway-domain:
      value: "api.paion-data.com"
      description: |
        The SSL-enabled domain that will serve various Kong API Gateway endpoints, such as its API and Kong Manager UI
  steps:
    - install-packer: sd-cmd exec paion-data/install-hashicorp-packer-ubuntu@latest
    - install-terraform: sd-cmd exec paion-data/install-hashicorp-terraform-ubuntu@latest
    - checkout-hashicorp-deployment-tool: git clone --depth 1 https://github.com/paion-data/immutable-infrastructure-as-a-service.git ../immutable-infrastructure-as-a-service

    - load-ssl-certificate-file: echo "$SSL_CERTIFICATE"         > ../immutable-infrastructure-as-a-service/hashicorp/kong-api-gateway/images/ssl.crt
    - load-ssl-certificate-key-file: echo "$SSL_CERTIFICATE_KEY" > ../immutable-infrastructure-as-a-service/hashicorp/kong-api-gateway/images/ssl.key

    - load-packer-variable-file: |
        echo region                  = \"$(meta get parameters.ami-region.value)\"              >> ../immutable-infrastructure-as-a-service/hashicorp/kong-api-gateway/images/ali.auto.pkrvars.hcl
        echo ali_image_name          = \"$(meta get parameters.ami-name.value)\"                >> ../immutable-infrastructure-as-a-service/hashicorp/kong-api-gateway/images/ali.auto.pkrvars.hcl
        echo instance_type           = \"$(meta get parameters.instance-type.value)\"           >> ../immutable-infrastructure-as-a-service/hashicorp/kong-api-gateway/images/ali.auto.pkrvars.hcl
        echo ssl_cert_source         = \"$(meta get parameters.instance-type.value)\"           >> ../immutable-infrastructure-as-a-service/hashicorp/kong-api-gateway/images/ali.auto.pkrvars.hcl
        echo ssl_cert_key_source     = \"$(meta get parameters.instance-type.value)\"           >> ../immutable-infrastructure-as-a-service/hashicorp/kong-api-gateway/images/ali.auto.pkrvars.hcl
        echo kong_api_gateway_domain = \"$(meta get parameters.kong-api-gateway-domain.value)\" >> ../immutable-infrastructure-as-a-service/hashicorp/kong-api-gateway/images/ali.auto.pkrvars.hcl

    - load-terraform-variable-file: |
        echo ali_image_name          = \"$(meta get parameters.ali-deploy-region.value)\"       >> ../immutable-infrastructure-as-a-service/hashicorp/kong-api-gateway/instances/ali.auto.tfvars
        echo instance_type           = \"$(meta get parameters.instance-type.value)\"           >> ../immutable-infrastructure-as-a-service/hashicorp/kong-api-gateway/instances/ali.auto.tfvars
        echo instance_name           = \"$(meta get parameters.instance-name.value)\"           >> ../immutable-infrastructure-as-a-service/hashicorp/kong-api-gateway/instances/ali.auto.tfvars
        echo security_groups         = \"$(meta get parameters.security-groups.value)"          >> ../immutable-infrastructure-as-a-service/hashicorp/kong-api-gateway/instances/ali.auto.tfvars
        echo vswitch_id              = \"$(meta get parameters.vswitch_id.value)\"              >> ../immutable-infrastructure-as-a-service/hashicorp/kong-api-gateway/instances/ali.auto.tfvars

    - packer-init: cd ../immutable-infrastructure-as-a-service/hashicorp/kong-api-gateway/images && packer init .
    - packer-validate: packer validate -var "skip_create_ami=true" .
    - packer-build: packer build -var "skip_create_ami=false" .

    - terraform-init: cd ../instances && terraform init
    - terraform-validate: terraform validate
    - terraform-apply: terraform apply -auto-approve
  secrets:
    - SSL_CERTIFICATE
    - SSL_CERTIFICATE_KEY
    - ALICLOUD_ACCESS_KEY
    - ALICLOUD_SECRET_KEY
